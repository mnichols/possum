<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width" charset="utf-8">
    <title>possum</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/cayman.min.css">
    <link rel="stylesheet" href="css/prism.min.css">
    <link rel="stylesheet" href="css/index.min.css">
    <link rel="stylesheet" href="css/docs.min.css">
    <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
  </head>
  <body data-spy="scroll" data-target=".scrollspy">
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container"><a class="brand">Mr. Doc</a>
          <div class="nav-collapse collapse">
            <ul class="nav pull-right sponsored"></ul>
          </div>
        </div>
      </div>
    </div>
    <header id="overview" class="jumbotron subhead">
      <div class="container">
        <h1>possum</h1>
        <p class="lead"></p>
      </div>
    </header>
    <div class="container">
      <div class="row">
        <div class="span3 bs-docs-sidebar">
          <ul class="nav nav-list bs-docs-sidenav affix-top">
            <li class="active"><a href="index.html">Main</a></li>
            <li><a href="possum.js.html">possum.js</a></li>
          </ul>
          <div class="scrollspy">
            <ul class="nav nav-list bs-docs-sidenav affix-top">
            </ul>
          </div>
        </div>
        <div class="span9">
          <section id="Main" class="readme"><pre><code class="language-js"> _  _  _ _    _  
|_)(_)_)_)|_|||| 
| state machine
</code></pre>
<blockquote>
<p>I am able.</p>
</blockquote>
<ul>
<li><em>From potis (“able, capable”) + sum (“I am”).</em></li>
</ul>
<p>========
<a href="https://github.com/mnichols/possum"><img style="position: absolute; top: 0; right: 0; border: 0;z-index:1100" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a></p>
<p><a href="https://travis-ci.org/mnichols/possum"><img src="https://travis-ci.org/mnichols/possum.svg?branch=master" alt="Build Status"></a></p>
<h2>License</h2>
<p><a href="https://raw.githubusercontent.com/mnichols/possum/master/LICENSE">MIT</a></p>
<h3>Install</h3>
<p><code>npm install --save possum</code></p>
<h3>Building</h3>
<p><code>make build</code> =&gt; <code>./build/possum.js</code></p>
<p>minified builds are broken atm</p>
<h3>Documentation</h3>
<p>Found <a href="https://mnichols.github.io/possum">here</a></p>
<h3>Example</h3>
<p><code>make example</code></p>
<h3>Module Support</h3>
<p>Works in nodejs and the browser.</p>
<h3>Getting Started</h3>
<blockquote>
<p>This is in the <code>app.js</code> for the example.</p>
</blockquote>
<pre><code class="language-js">
//listening to Kiss' Love Gun on my record player

//first, define our state machine spec

let gun = possum
    .config({
        namespace: 'kiss'
        , initialState: 'uninitialized'
    })
    .methods({
        enable: function(actions) {
            Object.keys(controls).forEach(function(key){
                controls[key].setAttribute('disabled','disabled')
            })
            if(!actions || !actions.length) {
                return
            }
            actions.forEach(function(action){
                controls[action].removeAttribute('disabled')
            })
        }
        ,loadWeapon: function(bullets){
            return this.bullets = bullets || [
                'I Stole Your Love'
                ,'Shock Me'
                ,'Love Gun'
            ]
        }
        ,fire: function(){
            //asynchronous, returns a Promise
            return this.recordPlayer.play(this.song)
        }
    })
    .states({
        'uninitialized': {
            _enter: function(){
                this.enable(['initialize'])
                return this.recordPlayer.turnOn()
            }
            ,'initialize': function(args) {
                return this.recordPlayer.spinRecord()
                    .then(this.transition.bind(this,'initialized'))
            }
        }
        ,'initialized': {
            _enter: function(){
                this.enable(['pullTrigger','load'])
            }
            ,'pullTrigger': function() {
                this.deferUntilTransition('aimed')
            }
            ,'load': function(args) {
                this.deferUntilTransition('loading')
                return this.transition('loading')
            }
        }
        ,'loading': {
            _enter: function(){
                this.enable(['load'])
            }
            ,'load': function(args) {
                this.loadWeapon(args &amp;&amp; args.bullets)
                return this.transition('loaded')
            }
            ,'reload': function() {
                return this.handle('load')
            }
        }
        ,'loaded': {
            _enter: function(){
                document.querySelector('.remaining').innerHTML = ''
                this.enable(['aim'])
            }
            ,'aim': function(args) {
                this.song = (args &amp;&amp; args.target) || this.bullets.shift()
                this.recordPlayer.hoverNeedleOver(this.song)
                return this.transition('aimed')
            }
        }
        ,'aimed':{
            _enter: function(){
                this.enable(['pullTrigger'])
            }
            ,'pullTrigger': function() {
                return this.fire()
                    .then(this.transition.bind(this,'smoking'))
            }
        }
        ,'smoking': {
            _enter: function(){
                console.log('light cigarette, sit back and relax')
                this.enable(['liftNeedle'])
            }
            ,'aim': function(args){
                this.deferUntilNextHandler()
                return this.handle('liftNeedle')
            }
            ,'liftNeedle': function(){
                if(this.bullets.length) {
                    return this.transition('loaded')
                }
                return this.transition('emptied')
            }
        }
        ,'emptied': {
            _enter: function(){
                this.enable(['reload'])
                return this.handle('aim')
            }
            ,'aim': function(args){
                return this.recordPlayer.returnArm()
            }
            ,'reload': function(){
                this.deferUntilTransition('loading')
                return this.transition('loading')
            }
        }

    })
    .create()

gun.currentState == 'uninitialized' // true

</code></pre>
<h3>What is a Possum?</h3>
<p>A marsupial.</p>
<p>But for our purposes, <code>possum</code> uses <a href="https://github.com/ericelliott/stampit">stampit</a> under-the-hood for
model prototyping.</p>
<p>This means that when you do this:</p>
<pre><code class="language-js">
var p = possum.states({ ... }).create()

</code></pre>
<p>A possum will compose any settings you put on the top level possum
call and then exposes this to the api (see below for more details):</p>
<pre><code class="language-js">possum
.config( /* configure initialState, namespace, etc */) // alias to stampit `props`
.states( /* configure states */) 
.methods(/* special methods */) //stampit method
.init(function(){
    //initializing stuff
    var secretData = 'shhhh'
    this.prop == 'erty' // -&gt; true
}) //stampit method
.compose(/* mixin other stamps into the machine */) //stampit method
.target(/* the state object to use (default is the machine itself) */)
.create() //this creates the possum instance; you may also just call it as a function

</code></pre>
<h3>Isolation and prototypes</h3>
<p>Every call to the builder functions on <code>possum</code> return a new stamp. This is important
to know and also to take advantage of. Consider the following:</p>
<pre><code class="language-js">
let loggable = possum.compose(logger)
let eventable = possum.compose(eventSourcer)
let kitchen = loggable.compose(eventable)

let model = loggable.config({initialState: 'a'}).create() //has loggable, not eventable, behavior
let model2 = eventable.config({initialState:'a'}).create() //has eventable, not loggable, behavior
let everything = kitchen.config({initialState:'a' }).create() // has both 
</code></pre>
<p>See the tests <a href="https://github.com/mnichols/possum/blob/master/test/composing-possum-test.js">here</a> for
seeing in action.</p>
<h3>Asynchronous and synchronous transitions and handlers</h3>
<p>Oftentimes handlers end up being async, breaking all the callers. Initially
<code>possum</code> did Promises for all api calls.</p>
<p>As of <code>v0.1.0</code> possum supports both synchronous and Promised handlers.</p>
<p>It is worth noting that the events which are emitted are ordered differently
depending on the flow model you choose.</p>
<h3>Possum Builder API (extensions atop stampit)</h3>
<h5><code>config</code> {Object} <strong>required</strong></h5>
<p>These attributes can (should) be set here:</p>
<h6><code>namespace</code> {String} [optional]</h6>
<p>The namespace for this instance</p>
<pre><code>var p = possum.config({
    namespace: 'secure'
})

</code></pre>
<h6><code>initialState</code> {String} <strong>required</strong></h6>
<p>The state to transition to initially</p>
<pre><code>var p = possum.config({
    initialState: 'uninitialized'
})
</code></pre>
<p>NOTE:</p>
<ul>
<li>the <code>_enter</code> callback will NOT get called immediately upon construction
if the state designated by  <code>initialState</code> has one. This is to avoid the
need for asynchronous instantiation support. If really need an initialization routing
you can just use stampit's built in facility for this:</li>
</ul>
<pre><code class="language-js">
var p = possum
.config({
    initialState: 'a'
})
.states({
    'a': {
        '_enter': function(){
            //wont get called on creation!
        }
    }
})
.init(function(){
    //do init stuff here
    //...you can even return a Promise and stampit will return the promise
    //for you to control it
})

</code></pre>
<h5><code>states</code> {Object} <strong>required</strong></h5>
<p>The states handlers configuration in the shape of:</p>
<pre><code class="language-js">var states = {
    'myState': {
        _enter: function( target ){
            //optional
            //steps to perform right when entering a state
            //can return an Promise for async support
        }
        ,'doIt': function(args, target) {
            //optionally make changes to the state target
            //handle the command 'doIt'
            //receiving exactly ONE argument
            return this.doIt()
        }
        ... 
        ,_exit: function( target ) {
            //optional
            //steps to perform right before transitioning
            //out of this state
        }
    }
}

</code></pre>
<p>Note that each state's input handler, will receive <em>one</em> <code>arguments</code> parameter. That means you must
invoke the handlers this way:</p>
<pre><code class="language-js">model.handle('doIt','myArgument')
</code></pre>
<p><strong>Additional arguments will be ignored</strong>.</p>
<h3>Possum Instance API</h3>
<h5><code>currentState</code> {String}</h5>
<p>The current state of the possum instance.
This is the same as <code>initialState</code> upon creation</p>
<h5><code>priorState</code> {String}</h5>
<p>The priorState state of the possum instance, if any.
This is <code>undefined</code> until a transition has occurred.</p>
<h5><code>namespaced([str,namespace])</code> {Function}</h5>
<p>Receives an optional <code>str</code> argument to produce an namespaced string using underlying delimiter rules.</p>
<p>If <code>str</code> is not provided, the instance's <code>namespace</code> is returned (from the spec).</p>
<p>If the instance has an <code>undefined</code> namespace the input <code>namespace</code> argument is used; if that is undefined
the <code>str</code> is returned.</p>
<p>This utility is used for producing underlying events for subscription; eg :</p>
<p><code>possumInstance.on(possumInstance.namespaced('handled'),function(){...})</code></p>
<h5><code>handle(inputType, args)</code> {Function}</h5>
<p>Queues the command <em>inputType</em> and processes it with the singular <em>args</em> payload.
Note that only <strong>one</strong> argument will be used. Other arguments will be ignored.</p>
<p>Returns the result of the handler (Promise or not)</p>
<h5><code>transition(toState)</code> {Function}</h5>
<p>Convenience method that queues the transition commands <code>exit</code>, <code>_transition</code>, and <code>_onEnter</code> and processes them.
Returns a Promise if an <code>_enter</code> or <code>_exit</code> handler does so; otherwise, it returns
the possum instance.</p>
<h5><code>deferUntilTransition(toState)</code> {Function}</h5>
<p>Queues the current message (input) to be replayed after the possum has transitioned
to <code>toState</code>. If <code>toState</code> is not provided, then it will replay after <em>any</em>
transition has occurred.</p>
<p>Returns <code>this</code> possum instance.</p>
<h3>Possum Events</h3>
<h5><code>{namespace}.handling</code></h5>
<p>Emitted <em>during</em> an input handler.</p>
<p>Event properties:</p>
<ul>
<li>topic: 'handling'</li>
<li>inputType: {String} the name of the handler you just called</li>
<li>payload: {Any} The arguments passed into the <code>handle</code> call</li>
<li>action: {String} the path of the handler you just called ; eg 'myState.myHandler'</li>
<li>namespace: {String} the namespace of the possum</li>
</ul>
<h5><code>{namespace}.invoked</code></h5>
<p>Emitted <em>just after</em> an input handler has been invoked but possibly before
the handler has completed (asynchronously).</p>
<p>Event properties:</p>
<ul>
<li>topic: 'invoked'</li>
<li>inputType: {String} the name of the handler you just called</li>
<li>payload: {Any} The arguments passed into the <code>handle</code> call</li>
<li>action: {String} the path of the handler you just called ; eg 'myState.myHandler'</li>
<li>namespace: {String} the namespace of the possum</li>
</ul>
<h5><code>{namespace}.handled</code></h5>
<p>Emitted <em>after</em> an input handler Promise has resolved (if async).</p>
<p>Event properties:</p>
<ul>
<li>topic: 'handled'</li>
<li>inputType: {String} the name of the handler you just called</li>
<li>payload: {Any} The arguments passed into the <code>handle</code> call</li>
<li>action: {String} the path of the handler you just called ; eg 'myState.myHandler'</li>
<li>namespace: {String} the namespace of the possum</li>
</ul>
<h5><code>{namespace}.transitioned</code></h5>
<p>Emitted <em>after</em> a possum has transitioned into a state,
and <em>after</em> its entry callback has been invoked (<code>_enter</code>).</p>
<p>Event properties:</p>
<ul>
<li>topic: 'transitioned'</li>
<li>inputType: {String} the name of the handler you just called</li>
<li>payload: {Object} having these properties
<ul>
<li><code>toState</code> The state you just transitioned to</li>
<li><code>fromState</code> The state you just transitioned from</li>
</ul>
</li>
<li>action: {String} the path of the handler you just called ; eg 'myState.myHandler'</li>
<li>namespace: {String} the namespace of the possum</li>
</ul>
<h5><code>{namespace}.noHandler</code></h5>
<p>Emitted when an input has been attempted on a state that does not declare it.</p>
<h4><code>{namespace}.invalidTransition</code></h4>
<p>Emitted when an transition is attempted to a state that does not exist.</p>
<h3>Tests</h3>
<ul>
<li><code>make test</code> will by default run tests on Node.</li>
<li><code>make browser</code> will run tape tests on any browser you visit at <code>http://localhost:2222</code></li>
</ul>
<h3>Roadmap</h3>
<ul>
<li>Hierarchical State Machine support</li>
<li>Behavior tree generation (ala <a href="https://github.com/maryrosecook/machinejs">machine.js</a>).</li>
</ul>
<h4>Acknowledgements</h4>
<p>API inspiration from <a href="https://github.com/ifandelse/machina.js">machina.js</a>.</p>
<h3>Credits</h3>
<ul>
<li><a href="https://github.com/ifandelse/machina.js">machina.js</a></li>
<li><a href="http://www.network-science.de/ascii/">ascii generation</a></li>
</ul>
</section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p>Documentation generated with <a href="https://github.com/mr-doc/mr-doc">Mr. Doc </a> created by <a href="https://twitter.com/FGRibreau" data-show-count="false" class="twitter-follow-button">Francois-Guillaume Ribreau </a></p>
        <p>Mr. Doc is sponsored by <a href="http://bringr.net/?btt" title="Outil d'analyse des réseaux sociaux" class="bringr">Bringr </a> and <a href="https://redsmin.com/?btt" title="Full Redis GUI" class="redsmin">Redsmin</a></p>
        <p>Theme borrowed from Twitter Bootstrap</p>
      </div>
    </footer>
    <script src="js/twitter-widget.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap-transition.min.js"></script>
    <script src="js/bootstrap-scrollspy.min.js"></script>
    <script src="js/bootstrap-dropdown.min.js"></script>
    <script src="js/bootstrap-collapse.min.js"></script>
    <script src="js/bootstrap-affix.min.js"></script>
    <script src="js/prism.min.js"></script>
    <script src="js/index.min.js"></script>
  </body>
</html>